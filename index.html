<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ä»‹è­·è¨˜éŒ²ï¼†å†™çœŸä¿å­˜ï¼ˆICFè©³ç´°ãƒ»Firebaseå¯¾å¿œï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }
    header {
      background: #4caf50;
      color: white;
      padding: 12px 16px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
    }
    main {
      padding: 12px;
      max-width: 900px;
      margin: 0 auto;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    .card h2 {
      margin: 0 0 8px;
      font-size: 16px;
    }
    label {
      display: block;
      font-size: 13px;
      margin: 4px 0 2px;
    }
    input[type="text"],
    input[type="password"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 7px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 13px;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    .input-row {
      display: flex;
      gap: 8px;
    }
    .input-row > div {
      flex: 1;
    }
    .btn {
      display: inline-block;
      padding: 8px 14px;
      border-radius: 6px;
      border: none;
      font-size: 13px;
      cursor: pointer;
      margin-top: 8px;
    }
    .btn-primary {
      background: #4caf50;
      color: white;
    }
    .btn-secondary {
      background: #607d8b;
      color: white;
    }
    .btn-danger {
      background: #f44336;
      color: white;
    }
    .btn:active {
      transform: translateY(1px);
    }
    .photo-preview {
      margin-top: 8px;
    }
    .photo-preview img {
      max-width: 120px;
      border-radius: 6px;
      display: block;
    }
    .records-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 8px 0;
      gap: 8px;
      flex-wrap: wrap;
    }
    .record-card {
      display: flex;
      gap: 8px;
      border-bottom: 1px solid #eee;
      padding: 8px 0;
    }
    .record-card:last-child {
      border-bottom: none;
    }
    .record-card img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 6px;
      cursor: pointer;
    }
    .record-info {
      flex: 1;
      font-size: 13px;
    }
    .record-meta {
      font-size: 11px;
      color: #666;
      margin-bottom: 4px;
    }
    .record-section-title {
      font-weight: bold;
      font-size: 12px;
      margin-top: 4px;
    }
    .empty-text {
      font-size: 13px;
      color: #777;
    }
    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }
    .filter-row > div {
      flex: 1;
      min-width: 120px;
    }
    small.help {
      font-size: 11px;
      color: #777;
    }
    .icf-block {
      margin-top: 10px;
      padding: 8px;
      border-radius: 6px;
      background: #f9fafb;
      border: 1px solid #e0e0e0;
    }
    .icf-block-title {
      font-size: 13px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå†™çœŸæ‹¡å¤§è¡¨ç¤ºï¼‰ */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .modal-backdrop.show {
      display: flex;
    }
    .modal-inner {
      max-width: 90vw;
      max-height: 90vh;
    }
    .modal-inner img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 8px;
    }
    .auth-info {
      font-size: 13px;
      color: #444;
      margin-top: 4px;
    }
    @media (max-width: 600px) {
      .record-card {
        flex-direction: row;
      }
      .record-card img {
        width: 72px;
        height: 72px;
      }
    }
  </style>
</head>
<body>
  <header>ä»‹è­·è¨˜éŒ²ï¼†å†™çœŸä¿å­˜ï¼ˆICFè©³ç´°ãƒ»Firebaseå¯¾å¿œï¼‰</header>
  <main>
    <!-- ğŸ” ãƒ­ã‚°ã‚¤ãƒ³ï¼ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ— -->
    <section class="card" id="authSection">
      <h2>ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</h2>
      <label for="authEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
      <input id="authEmail" type="text" placeholder="example@example.com" />

      <label for="authPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
      <input id="authPassword" type="password" placeholder="6æ–‡å­—ä»¥ä¸Š" />

      <button class="btn btn-primary" id="loginBtn">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button class="btn btn-secondary" id="signupBtn">æ–°è¦ç™»éŒ²</button>

      <div class="auth-info" id="authMessage"></div>
    </section>

    <!-- ğŸ‘¤ ãƒ­ã‚°ã‚¤ãƒ³ä¸­æƒ…å ± -->
    <section class="card" id="userSection" style="display:none;">
      <div>
        ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š<span id="userEmail"></span>
      </div>
      <button class="btn" id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </section>

    <!-- ã‚¢ãƒ—ãƒªæœ¬ä½“ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œã«è¡¨ç¤ºï¼‰ -->
    <div id="appSection" style="display:none;">
      <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
      <section class="card">
        <h2>æ–°ã—ã„è¨˜éŒ²ã‚’è¿½åŠ </h2>

        <div class="input-row">
          <div>
            <label for="careDate">æ—¥ä»˜</label>
            <input id="careDate" type="date" />
          </div>
          <div>
            <label for="patientId">æ‚£è€…ç•ªå·</label>
            <input id="patientId" type="text" placeholder="ä¾‹ï¼šA-001" />
          </div>
        </div>

        <label for="name">åå‰ï¼ˆåˆ©ç”¨è€…ã•ã‚“ï¼‰</label>
        <input id="name" type="text" placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ" />

        <label for="allergy">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</label>
        <input id="allergy" type="text" placeholder="ä¾‹ï¼šåµã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã€èŠ±ç²‰ç—‡ãªã©" />

        <label for="note">ãƒ¡ãƒ¢ï¼ˆä»‹è­·å†…å®¹ãƒ»æ§˜å­ãªã©ï¼‰</label>
        <textarea id="note" placeholder="ä¾‹ï¼šæ˜¼é£Ÿã¯å®Œé£Ÿã€‚15åˆ†ã»ã©æ•£æ­©ã€‚ç‰¹ã«ç•°å¸¸ãªã—ã€‚"></textarea>

        <!-- ICFè©•ä¾¡ãƒ–ãƒ­ãƒƒã‚¯ -->
        <div class="icf-block">
          <div class="icf-block-title">ICFã®è©•ä¾¡</div>

          <label for="icfActivityLevel">
            æ´»å‹•ãƒ¬ãƒ™ãƒ«ï¼ˆ1ã€œ5ï¼‰<br>
            <small class="help">1ï¼å…¨ä»‹åŠ© / 2ï¼å¤šãã®ä»‹åŠ© / 3ï¼ä¸€éƒ¨ä»‹åŠ© / 4ï¼è¦‹å®ˆã‚Š / 5ï¼è‡ªç«‹</small>
          </label>
          <select id="icfActivityLevel">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="1ï¼šå…¨ä»‹åŠ©">1ï¼šå…¨ä»‹åŠ©</option>
            <option value="2ï¼šå¤šãã®ä»‹åŠ©">2ï¼šå¤šãã®ä»‹åŠ©</option>
            <option value="3ï¼šä¸€éƒ¨ä»‹åŠ©">3ï¼šä¸€éƒ¨ä»‹åŠ©</option>
            <option value="4ï¼šè¦‹å®ˆã‚Š">4ï¼šè¦‹å®ˆã‚Š</option>
            <option value="5ï¼šè‡ªç«‹">5ï¼šè‡ªç«‹</option>
          </select>

          <label for="icfEnvironment">ç’°å¢ƒå› å­</label>
          <textarea id="icfEnvironment" placeholder="ä¾‹ï¼šå®¶æ—ã®å”åŠ›è‰¯å¥½ã€‚ä½å®…å†…ã«æ®µå·®å°‘ãªãã€æ‰‹ã™ã‚Šã‚ã‚Šã€‚ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹é€±3å›åˆ©ç”¨ã€‚"></textarea>

          <label for="icfMemo">ICFãƒ¡ãƒ¢</label>
          <textarea id="icfMemo" placeholder="ICFå…¨ä½“ã«é–¢ã™ã‚‹è£œè¶³ãƒ¡ãƒ¢ãªã©ã€‚"></textarea>
        </div>

        <div class="input-row">
          <div>
            <label for="temperature">ä½“æ¸©ï¼ˆâ„ƒï¼‰</label>
            <input id="temperature" type="number" step="0.1" placeholder="ä¾‹ï¼š36.8" />
          </div>
          <div>
            <label for="pulse">è„ˆæ‹ï¼ˆå›/åˆ†ï¼‰</label>
            <input id="pulse" type="number" step="1" placeholder="ä¾‹ï¼š72" />
          </div>
        </div>

        <label for="toiletStatus">ãƒˆã‚¤ãƒ¬çŠ¶æ³</label>
        <textarea id="toiletStatus" placeholder="ä¾‹ï¼šãƒˆã‚¤ãƒ¬èª˜å°ã§è‡ªç«‹ã€‚å¤œé–“1å›ã€‚å¤±ç¦ãªã—ã€‚"></textarea>

        <div class="input-row">
          <div>
            <label for="mealAmount">é£Ÿäº‹é‡</label>
            <select id="mealAmount">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="å®Œé£Ÿ">å®Œé£Ÿ</option>
              <option value="8å‰²ç¨‹åº¦">8å‰²ç¨‹åº¦</option>
              <option value="åŠåˆ†ãã‚‰ã„">åŠåˆ†ãã‚‰ã„</option>
              <option value="å°‘é‡">å°‘é‡</option>
              <option value="ã»ã¨ã‚“ã©ç„¡ã—">ã»ã¨ã‚“ã©ç„¡ã—</option>
            </select>
          </div>
        </div>

        <label for="mealContent">é£Ÿäº‹å†…å®¹</label>
        <textarea id="mealContent" placeholder="ä¾‹ï¼šã”é£¯ã€ã¿ãæ±ã€ç„¼ãé­šã€ã‚µãƒ©ãƒ€ã€ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ"></textarea>

        <label for="medicationStatus">è–¬ã®æ‘‚å–çŠ¶æ³</label>
        <textarea id="medicationStatus" placeholder="ä¾‹ï¼šæœé£Ÿå¾Œã®å†…æœã¯å…¨ã¦å†…æœç¢ºèªã€‚çœ å‰è–¬ã‚‚å†…æœæ¸ˆã¿ã€‚"></textarea>

        <label for="photo">å†™çœŸï¼ˆã‚«ãƒ¡ãƒ© or ã‚®ãƒ£ãƒ©ãƒªãƒ¼ï¼‰</label>
        <input
          id="photo"
          type="file"
          accept="image/*"
          capture="environment"
        />
        <small class="help">â€»å¯¾å¿œç«¯æœ«ã§ã¯ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã—ã¾ã™ã€‚</small>

        <div class="photo-preview" id="photoPreview"></div>

        <button class="btn btn-primary" id="saveBtn">è¨˜éŒ²ã‚’ä¿å­˜</button>
      </section>

      <!-- æ¤œç´¢ãƒ»çµã‚Šè¾¼ã¿ -->
      <section class="card">
        <h2>æ¤œç´¢ãƒ»çµã‚Šè¾¼ã¿</h2>
        <div class="filter-row">
          <div>
            <label for="filterDateFrom">æ—¥ä»˜ï¼ˆé–‹å§‹ï¼‰</label>
            <input id="filterDateFrom" type="date" />
          </div>
          <div>
            <label for="filterDateTo">æ—¥ä»˜ï¼ˆçµ‚äº†ï¼‰</label>
            <input id="filterDateTo" type="date" />
          </div>
          <div>
            <label for="filterPatientId">æ‚£è€…ç•ªå·</label>
            <input id="filterPatientId" type="text" placeholder="ä¾‹ï¼šA-001" />
          </div>
        </div>
        <button class="btn btn-secondary" id="applyFilterBtn">çµã‚Šè¾¼ã¿</button>
        <button class="btn" id="clearFilterBtn">çµã‚Šè¾¼ã¿è§£é™¤</button>
        <div>
          <small class="help">
            â€»æ—¥ä»˜ã¯ã€Œã‚±ã‚¢æ—¥ã€ã§æ¤œç´¢ã—ã¾ã™ã€‚æ‚£è€…ç•ªå·ã¯å®Œå…¨ä¸€è‡´ã§çµã‚Šè¾¼ã¿ã¾ã™ã€‚
          </small>
        </div>
      </section>

      <!-- è¨˜éŒ²ä¸€è¦§ -->
      <section class="card">
        <div class="records-header">
          <h2>ä¿å­˜ã—ãŸè¨˜éŒ²</h2>
          <button class="btn btn-danger" id="clearAllBtn">å…¨å‰Šé™¤</button>
        </div>
        <div id="recordsContainer"></div>
      </section>
    </div>
  </main>

  <!-- å†™çœŸæ‹¡å¤§ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-backdrop" id="photoModal">
    <div class="modal-inner">
      <img id="modalImage" src="" alt="æ‹¡å¤§å†™çœŸ" />
    </div>
  </div>

  <!-- Firebase + ã‚¢ãƒ—ãƒªãƒ­ã‚¸ãƒƒã‚¯ -->
  <script type="module">
    // ğŸ”¥ Firebase SDK èª­ã¿è¾¼ã¿
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut,
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      deleteDoc,
      doc,
      writeBatch,
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // â­â­ ã“ã“ã‚’æ›¸ãæ›ãˆã¦ãã ã•ã„ï¼ˆFirebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®è¨­å®šã‚’è²¼ã‚Šä»˜ã‘ï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyBqyUcPQ4krG8ez2Orhdfoequ5QdAAZBtQ",
      authDomain: "kaigo-48b37.firebaseapp.com",
      projectId: "kaigo-48b37",
      storageBucket: "kaigo-48b37.firebasestorage.app",
      messagingSenderId: "818802593664",
      appId: "1:818802593664:web:21ea9d81e25cee73917b65",
      measurementId: "G-6L7Y6LNCLV"
     };

    // Firebase åˆæœŸåŒ–
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOMè¦ç´  ---------------

    // Auth
    const authSection = document.getElementById("authSection");
    const userSection = document.getElementById("userSection");
    const appSection = document.getElementById("appSection");
    const authEmailInput = document.getElementById("authEmail");
    const authPasswordInput = document.getElementById("authPassword");
    const authMessage = document.getElementById("authMessage");
    const userEmailSpan = document.getElementById("userEmail");
    const loginBtn = document.getElementById("loginBtn");
    const signupBtn = document.getElementById("signupBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    // App
    const careDateInput = document.getElementById("careDate");
    const patientIdInput = document.getElementById("patientId");
    const nameInput = document.getElementById("name");
    const allergyInput = document.getElementById("allergy");
    const noteInput = document.getElementById("note");
    const icfActivityLevelInput = document.getElementById("icfActivityLevel");
    const icfEnvironmentInput = document.getElementById("icfEnvironment");
    const icfMemoInput = document.getElementById("icfMemo");
    const temperatureInput = document.getElementById("temperature");
    const pulseInput = document.getElementById("pulse");
    const toiletStatusInput = document.getElementById("toiletStatus");
    const mealAmountInput = document.getElementById("mealAmount");
    const mealContentInput = document.getElementById("mealContent");
    const medicationStatusInput = document.getElementById("medicationStatus");
    const photoInput = document.getElementById("photo");
    const photoPreview = document.getElementById("photoPreview");
    const saveBtn = document.getElementById("saveBtn");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const recordsContainer = document.getElementById("recordsContainer");

    const filterDateFromInput = document.getElementById("filterDateFrom");
    const filterDateToInput = document.getElementById("filterDateTo");
    const filterPatientIdInput = document.getElementById("filterPatientId");
    const applyFilterBtn = document.getElementById("applyFilterBtn");
    const clearFilterBtn = document.getElementById("clearFilterBtn");

    const photoModal = document.getElementById("photoModal");
    const modalImage = document.getElementById("modalImage");

    let tempPhotoDataUrl = null;
    let currentUser = null;
    let recordsCache = []; // Firestoreã‹ã‚‰èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ

    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’åˆæœŸå€¤ã«
    function setTodayToCareDate() {
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth() + 1).padStart(2, "0");
      const d = String(today.getDate()).padStart(2, "0");
      careDateInput.value = `${y}-${m}-${d}`;
    }

    // ç”»åƒé¸æŠæ™‚ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
    photoInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) {
        tempPhotoDataUrl = null;
        photoPreview.innerHTML = "";
        return;
      }
      const reader = new FileReader();
      reader.onload = function(ev) {
        tempPhotoDataUrl = ev.target.result;
        photoPreview.innerHTML = "<img src='" + tempPhotoDataUrl + "' alt='ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼' />";
      };
      reader.readAsDataURL(file);
    });

    // ğŸ” Authå‡¦ç† ---------------------------------

    function setAuthMessage(msg) {
      authMessage.textContent = msg;
    }

    loginBtn.addEventListener("click", async () => {
      const email = authEmailInput.value.trim();
      const password = authPasswordInput.value.trim();
      if (!email || !password) {
        setAuthMessage("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      try {
        await signInWithEmailAndPassword(auth, email, password);
        setAuthMessage("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚");
      } catch (e) {
        console.error(e);
        setAuthMessage("ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
      }
    });

    signupBtn.addEventListener("click", async () => {
      const email = authEmailInput.value.trim();
      const password = authPasswordInput.value.trim();
      if (!email || !password) {
        setAuthMessage("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      try {
        await createUserWithEmailAndPassword(auth, email, password);
        setAuthMessage("æ–°è¦ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã«ãªã‚Šã¾ã—ãŸã€‚");
      } catch (e) {
        console.error(e);
        setAuthMessage("æ–°è¦ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, async (user) => {
      currentUser = user || null;

      if (user) {
        authSection.style.display = "none";
        userSection.style.display = "block";
        appSection.style.display = "block";
        userEmailSpan.textContent = user.email || "(ãƒ¡ãƒ¼ãƒ«æœªè¨­å®š)";
        setAuthMessage("");
        await fetchRecordsFromFirestore();
      } else {
        authSection.style.display = "block";
        userSection.style.display = "none";
        appSection.style.display = "none";
        userEmailSpan.textContent = "";
        recordsCache = [];
        recordsContainer.innerHTML = "";
      }
    });

    // ğŸ—„ Firestore ã‹ã‚‰è¨˜éŒ²ã‚’å–å¾— -------------------

    async function fetchRecordsFromFirestore() {
      if (!currentUser) return;
      try {
        const colRef = collection(db, "users", currentUser.uid, "records");
        const snap = await getDocs(colRef);
        const list = [];
        snap.forEach((docSnap) => {
          const data = docSnap.data();
          list.push({
            id: docSnap.id,
            ...data,
          });
        });
        // createdAtã®æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ
        list.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
        recordsCache = list;
        renderRecords();
      } catch (e) {
        console.error("fetchRecords error", e);
        alert("è¨˜éŒ²ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    }

    // çµã‚Šè¾¼ã¿æ¡ä»¶ã‚’å–å¾—
    function getFilterConditions() {
      return {
        dateFrom: filterDateFromInput.value || null,
        dateTo: filterDateToInput.value || null,
        patientId: filterPatientIdInput.value.trim() || null,
      };
    }

    // è¨˜éŒ²ä¸€è¦§ã‚’æç”»ï¼ˆrecordsCacheã«åŸºã¥ã„ã¦ï¼‰
    function renderRecords() {
      recordsContainer.innerHTML = "";

      if (!recordsCache || recordsCache.length === 0) {
        const p = document.createElement("p");
        p.className = "empty-text";
        p.textContent = "ã¾ã è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚";
        recordsContainer.appendChild(p);
        return;
      }

      const filters = getFilterConditions();

      const filtered = recordsCache.filter((record) => {
        const careDate = record.careDate || "";
        if (filters.dateFrom && careDate && careDate < filters.dateFrom) {
          return false;
        }
        if (filters.dateTo && careDate && careDate > filters.dateTo) {
          return false;
        }
        if (filters.patientId && record.patientId !== filters.patientId) {
          return false;
        }
        return true;
      });

      if (filtered.length === 0) {
        const p = document.createElement("p");
        p.className = "empty-text";
        p.textContent = "çµã‚Šè¾¼ã¿æ¡ä»¶ã«åˆã†è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
        recordsContainer.appendChild(p);
        return;
      }

      filtered.forEach((record) => {
        const card = document.createElement("div");
        card.className = "record-card";

        if (record.photoDataUrl) {
          const img = document.createElement("img");
          img.src = record.photoDataUrl;
          img.alt = "è¨˜éŒ²å†™çœŸ";
          img.addEventListener("click", () => openPhotoModal(record.photoDataUrl));
          card.appendChild(img);
        }

        const info = document.createElement("div");
        info.className = "record-info";

        const meta = document.createElement("div");
        meta.className = "record-meta";

        const createdStr = record.createdAt
          ? new Date(record.createdAt).toLocaleString("ja-JP")
          : "";
        const careDateStr = record.careDate ? record.careDate : "æ—¥ä»˜æœªå…¥åŠ›";
        const patientIdStr = record.patientId || "æ‚£è€…ç•ªå·ãªã—";
        const nameStr = record.name || "åå‰ãªã—";

        meta.textContent = `ã‚±ã‚¢æ—¥: ${careDateStr} / æ‚£è€…ç•ªå·: ${patientIdStr} / æ°å: ${nameStr} / ç™»éŒ²: ${createdStr}`;
        info.appendChild(meta);

        if (record.allergy) {
          const allergyTitle = document.createElement("div");
          allergyTitle.className = "record-section-title";
          allergyTitle.textContent = "ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼";
          info.appendChild(allergyTitle);

          const allergy = document.createElement("div");
          allergy.textContent = record.allergy;
          info.appendChild(allergy);
        }

        if (record.note) {
          const noteTitle = document.createElement("div");
          noteTitle.className = "record-section-title";
          noteTitle.textContent = "ãƒ¡ãƒ¢";
          info.appendChild(noteTitle);

          const note = document.createElement("div");
          note.textContent = record.note;
          info.appendChild(note);
        }

        if (record.icfActivityLevel || record.icfEnvironment || record.icfMemo) {
          const icfTitle = document.createElement("div");
          icfTitle.className = "record-section-title";
          icfTitle.textContent = "ICFã®è©•ä¾¡";
          info.appendChild(icfTitle);

          if (record.icfActivityLevel) {
            const act = document.createElement("div");
            act.textContent = `æ´»å‹•ãƒ¬ãƒ™ãƒ«: ${record.icfActivityLevel}`;
            info.appendChild(act);
          }
          if (record.icfEnvironment) {
            const env = document.createElement("div");
            env.textContent = `ç’°å¢ƒå› å­: ${record.icfEnvironment}`;
            info.appendChild(env);
          }
          if (record.icfMemo) {
            const memo = document.createElement("div");
            memo.textContent = `ãƒ¡ãƒ¢: ${record.icfMemo}`;
            info.appendChild(memo);
          }
        }

        if (record.temperature || record.pulse) {
          const vitalTitle = document.createElement("div");
          vitalTitle.className = "record-section-title";
          vitalTitle.textContent = "ãƒã‚¤ã‚¿ãƒ«";
          info.appendChild(vitalTitle);

          const vital = document.createElement("div");
          const vitalParts = [];
          if (record.temperature) vitalParts.push(`ä½“æ¸©: ${record.temperature}â„ƒ`);
          if (record.pulse) vitalParts.push(`è„ˆæ‹: ${record.pulse} å›/åˆ†`);
          vital.textContent = vitalParts.join(" / ");
          info.appendChild(vital);
        }

        if (record.toiletStatus) {
          const toiletTitle = document.createElement("div");
          toiletTitle.className = "record-section-title";
          toiletTitle.textContent = "ãƒˆã‚¤ãƒ¬çŠ¶æ³";
          info.appendChild(toiletTitle);

          const toilet = document.createElement("div");
          toilet.textContent = record.toiletStatus;
          info.appendChild(toilet);
        }

        if (record.mealAmount || record.mealContent) {
          const mealTitle = document.createElement("div");
          mealTitle.className = "record-section-title";
          mealTitle.textContent = "é£Ÿäº‹";
          info.appendChild(mealTitle);

          const meal = document.createElement("div");
          const lines = [];
          if (record.mealAmount) lines.push(`é‡: ${record.mealAmount}`);
          if (record.mealContent) lines.push(`å†…å®¹: ${record.mealContent}`);
          meal.textContent = lines.join(" / ");
          info.appendChild(meal);
        }

        if (record.medicationStatus) {
          const medTitle = document.createElement("div");
          medTitle.className = "record-section-title";
          medTitle.textContent = "è–¬ã®æ‘‚å–çŠ¶æ³";
          info.appendChild(medTitle);

          const med = document.createElement("div");
          med.textContent = record.medicationStatus;
          info.appendChild(med);
        }

        card.appendChild(info);
        recordsContainer.appendChild(card);
      });
    }

    // è¨˜éŒ²ã‚’ä¿å­˜
    saveBtn.addEventListener("click", async () => {
      if (!currentUser) {
        alert("ã¾ãšãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const careDate = careDateInput.value;
      const patientId = patientIdInput.value.trim();
      const name = nameInput.value.trim();
      const allergy = allergyInput.value.trim();
      const note = noteInput.value.trim();
      const icfActivityLevel = icfActivityLevelInput.value;
      const icfEnvironment = icfEnvironmentInput.value.trim();
      const icfMemo = icfMemoInput.value.trim();
      const temperature = temperatureInput.value.trim();
      const pulse = pulseInput.value.trim();
      const toiletStatus = toiletStatusInput.value.trim();
      const mealAmount = mealAmountInput.value;
      const mealContent = mealContentInput.value.trim();
      const medicationStatus = medicationStatusInput.value.trim();

      if (
        !careDate && !patientId && !name && !note &&
        !tempPhotoDataUrl &&
        !icfActivityLevel && !icfEnvironment && !icfMemo &&
        !allergy && !toiletStatus &&
        !mealAmount && !mealContent && !medicationStatus &&
        !temperature && !pulse
      ) {
        alert("ã„ãšã‚Œã‹ä¸€ã¤ä»¥ä¸Šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const now = Date.now();
      const newRecord = {
        careDate,
        patientId,
        name,
        allergy,
        note,
        icfActivityLevel,
        icfEnvironment,
        icfMemo,
        temperature,
        pulse,
        toiletStatus,
        mealAmount,
        mealContent,
        medicationStatus,
        photoDataUrl: tempPhotoDataUrl,
        createdAt: now,
      };

      try {
        const colRef = collection(db, "users", currentUser.uid, "records");
        await addDoc(colRef, newRecord);

        // å…¥åŠ›ãƒªã‚»ãƒƒãƒˆï¼ˆcareDateã¯ãã®ã¾ã¾ï¼‰
        patientIdInput.value = "";
        nameInput.value = "";
        allergyInput.value = "";
        noteInput.value = "";
        icfActivityLevelInput.value = "";
        icfEnvironmentInput.value = "";
        icfMemoInput.value = "";
        temperatureInput.value = "";
        pulseInput.value = "";
        toiletStatusInput.value = "";
        mealAmountInput.value = "";
        mealContentInput.value = "";
        medicationStatusInput.value = "";
        photoInput.value = "";
        tempPhotoDataUrl = null;
        photoPreview.innerHTML = "";

        await fetchRecordsFromFirestore();
        alert("è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
      } catch (e) {
        console.error("save error", e);
        alert("è¨˜éŒ²ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    });

    // å…¨å‰Šé™¤
    clearAllBtn.addEventListener("click", async () => {
      if (!currentUser) {
        alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      if (!confirm("ã™ã¹ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰")) return;

      try {
        const colRef = collection(db, "users", currentUser.uid, "records");
        const snap = await getDocs(colRef);
        const batch = writeBatch(db);
        snap.forEach((docSnap) => {
          batch.delete(doc(db, "users", currentUser.uid, "records", docSnap.id));
        });
        await batch.commit();
        recordsCache = [];
        renderRecords();
      } catch (e) {
        console.error("clearAll error", e);
        alert("å…¨å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    });

    // çµã‚Šè¾¼ã¿ãƒœã‚¿ãƒ³
    applyFilterBtn.addEventListener("click", () => {
      renderRecords();
    });

    // çµã‚Šè¾¼ã¿è§£é™¤
    clearFilterBtn.addEventListener("click", () => {
      filterDateFromInput.value = "";
      filterDateToInput.value = "";
      filterPatientIdInput.value = "";
      renderRecords();
    });

    // å†™çœŸæ‹¡å¤§ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«
    function openPhotoModal(dataUrl) {
      modalImage.src = dataUrl;
      photoModal.classList.add("show");
    }
    photoModal.addEventListener("click", () => {
      photoModal.classList.remove("show");
    });

    // åˆæœŸè¡¨ç¤º
    setTodayToCareDate();
  </script>
</body>
</html>

